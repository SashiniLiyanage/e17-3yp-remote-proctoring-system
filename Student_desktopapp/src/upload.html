<!DOCTYPE html>
<html>

<head>
    <title>Connexa</title>
    <link rel="stylesheet" href="css/header.css">
    <script defer src="js/header.js"></script>
    <style>
        #uploadbtn:disabled,
        #uploadcancle:disabled {
            background-color: rgb(173, 173, 173);
            cursor: not-allowed;
        }
        
        #uploadStatus {
            margin-left: auto;
            margin-right: auto;
        }
        
        #errorMsg {
            text-align: center;
        }
        
        #saved-files {
            padding: 10px;
        }
        
        #saved-files p {
            background-color: var(--sub-color);
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        #saved-files p:before {
            content: '\1F3A5';
            padding-right: 10px;
        }
        
        #saved-files h4 {
            color: var(--header-color);
            font-weight: normal;
            margin-top: 0px;
        }
    </style>
</head>

<body onload="display_ct();">
    <div class="header">
        <div class="container1">
            <div class="title">
                <span id='title'>Upload</span>
            </div>
        </div>
        <div class="container2" onclick="refresh();"></div>
        <div class="container3">
            <div class="battery">
                <div class="container">
                    <div id="batBody">
                        <div id="indicator"></div>
                    </div>
                    <div class="batEnd">
                        <div></div>
                    </div>
                </div>
                <p id="batteryLevelOutput"></p>
            </div>
        </div>
    </div>

    <div class="timestamp" id="timestamp">
        <p>TIME TO HIT THE BOOKS! YOUR NEXT EXAM BEGINS IN:</p>
    </div>

    <div class="status" id="status"></div>

    <div class="timeindicator" id="timeindicator">
        <p class="time">2 : <span id="currenttime"></span></p>
        <p>DAYS : HOURS : MINUTES : SECONDS</p>
    </div>

    <!--hamburger menu-->
    <nav class="menu" tabindex="0">
        <div class="smartphone-menu-trigger"></div>
        <header class="avatar">
            <img id="avatar" class="online" src="img/user.jpg" />
            <h2 id="user_name">USER</h2>
        </header>
        <ul id="list">
            <li tabindex="0" id="home" class="icon-home"><span>Home</span></li>
            <li tabindex="0" id="dashboard" class="icon-dashboard"><span>Dashboard</span></li>
            <li tabindex="0" id="course" class="icon-courses"><span>Courses</span></li>
            <li tabindex="0" id="schedule" class="icon-schedule"><span>Exam Schedule</span></li>
            <li tabindex="0" id="upload" class="icon-upload"><span>Upoad Videos</span></li>
            <li tabindex="0" id="settings" class="icon-settings"><span>Settings</span></li>
            <li tabindex="0" id="help" class="icon-help"><span>Help</span></li>
        </ul>
    </nav>
    <!--body starts here-->
    <div class="separator2"></div>
    <div id='saved-files'>
        <h4>Click on the videos to upload them</h4>
    </div>

    <a id="show" href="#popup"></a>


    <div id="popup" class="overlay">
        <div id='data' class="popup">
            <h4>Saved Video Details</h4>
            <!--body starts here-->
            <p>name: <span id='filename'>null</span></p>
            <p>created time : <span>null</span></p>
            <p>size: <span>null</span>MB</p>
            <img id='uploadStatus' src='' style=" display: none" />
            <p id='errorMsg'></p>
            <div class="center">
                <button class="button" name='upload' id='uploadbtn' onclick="upload()">Upload</button>
                <button class="button" name='close' id='uploadcancle' onclick="cancle()">Close</button>
            </div>

        </div>
    </div>


    <script>
        var fs = require('fs');
        var files = fs.readdirSync('src/recordedVideo');
        var list = document.getElementById('saved-files');

        const errorMsg = document.getElementById('errorMsg');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadbtn = document.getElementById('uploadbtn')
        const canclebtn = document.getElementById('uploadcancle')

        for (var i = 0; i < files.length; i++) {


            var item = document.createElement('p');
            item.setAttribute("id", i.toString());
            item.innerHTML = files[i];
            // fs.stat('src/recordedVideo/' + files[i], (err, stats) => {
            //     console.log(stats)
            // });

            list.appendChild(item);


        }


        var popup = document.getElementById("popup");
        var link = document.getElementById("show")
        var btn = document.getElementById("saved-files").getElementsByTagName('p')
        var btncount = btn.length;
        for (var i = 0; i < btncount; i += 1) {
            btn[i].onclick = function() {
                var data = document.getElementById("data").getElementsByTagName('span')
                var video = document.getElementById(this.id);
                fs.stat('src/recordedVideo/' + video.innerHTML, (err, stats) => {
                    //console.log(stats)
                    data[0].innerHTML = video.innerHTML;
                    data[1].innerHTML = stats.birthtime;
                    data[2].innerHTML = Math.round(stats.size / 10000) / 100;
                });
                link.click()
            }
        }

        function cancle() {
            uploadStatus.style.display = 'none'
            uploadbtn.disabled = false;
            errorMsg.innerHTML = '';
            uploadStatus.src = '';
            //ipc.send('upload');
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = '#';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                location.reload();
            }, 200);

        }

        function upload() {
            if (!(navigator.onLine)) {
                closePopup();
                return;
            }

            uploadbtn.disabled = true;
            canclebtn.disabled = true;
            var filename = document.getElementById('filename').innerHTML;
            errorMsg.innerHTML = 'Uploading....';
            uploadStatus.style.display = 'block'
            uploadStatus.src = 'img/icons/uploading.gif';

            ipc.send("googleDriveUpload", {
                fileName: filename,
            })

            ipc.on("done", async(event, {
                errormsg
            }) => {
                canclebtn.disabled = false;
                if (errormsg == 'noError') {
                    errorMsg.innerHTML = "Video Uploaded Successfully";
                    uploadStatus.src = 'img/icons/success.png'

                    fs.unlink('src/recordedVideo/' + filename, function(err) {
                        console.log(err);

                    });


                } else {
                    errorMsg.innerHTML = errormsg;
                    uploadStatus.src = 'img/icons/fail.png'

                }

            })
        }


        // navigator.connection.addEventListener('change', logNetworkInfo());

        // function logNetworkInfo() {
        //     // Network type that browser uses
        //     console.log('         type: ' + navigator.connection.type);

        //     // Effective bandwidth estimate
        //     console.log('     downlink: ' + navigator.connection.downlink + ' Mb/s');

        //     // Effective round-trip time estimate
        //     console.log('          rtt: ' + navigator.connection.rtt + ' ms');

        //     // Upper bound on the downlink speed of the first network hop
        //     console.log('  downlinkMax: ' + navigator.connection.downlinkMax + ' Mb/s');

        //     // Effective connection type determined using a combination of recently
        //     // observed rtt and downlink values: ' +
        //     console.log('effectiveType: ' + navigator.connection.effectiveType);

        //     // True if the user has requested a reduced data usage mode from the user
        //     // agent.
        //     console.log('     saveData: ' + navigator.connection.saveData);

        //     // Add whitespace for readability
        //     console.log('');
        // }

        // logNetworkInfo();
    </script>
</body>

</html>